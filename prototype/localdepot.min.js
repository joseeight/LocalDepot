/**
 * Copyright (C) 2014, Tradeshift. All Rights Reserved.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 *
 * @author jam@tradeshift.com (José Antonio Márquez Russo)
 * https://github.com/Tradeshift/LocalDepot
 */
"undefined"!=typeof window&&!function(){"use strict";if(!window.LocalDepot){window.indexedDB||(window.indexedDB=window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB);var a=window.LocalDepot={};a.onError=null,a.deviceStorageType=null,a.indexedDbVersion=1,a.DB_INDEXING_KEY="item",a.storageType={INDEXEDDB:"indexeddb",WEBSQL:"websql",LOCALSTORAGE:"localstorage"},a.Depot=function(b,c){this.name=b,this.storageType=c,this.getItem=function(b,c){a._Depot.getItem(this,b,c)},this.getKeys=function(b){a._Depot.getKeys(this,b)},this.setItem=function(b,c,d){a._Depot.setItem(this,b,c,d)},this.hasItem=function(b,c){a._Depot.hasItem(this,b,c)},this.removeItem=function(b,c){a._Depot.removeItem(this,b,c)},this.clear=function(){a._Depot.clear(this)}},a._Depot={getItem:function(b,c,d){b.storageType===a.storageType.INDEXEDDB&&a._Depot.openIndexedDb(b.name,a.indexedDbVersion,function(e){var f,g,h;g=e.transaction([b.name]),f=g.objectStore(b.name),h=f.get(c),h.onsuccess=function(b){var c=b.target.result;"function"==typeof d&&d(c?c.data:void 0),a._Depot.closeIndexedDb(e)},h.onerror=function(){"function"==typeof d&&d(void 0),a._Depot.closeIndexedDb(e)}})},getKeys:function(b,c){b.storageType===a.storageType.INDEXEDDB?a._Depot.openIndexedDb(b.name,a.indexedDbVersion,function(d){var e,f,g,h=[];f=d.transaction([b.name]),e=f.objectStore(b.name),g=e.openCursor(),g.onsuccess=function(b){var e=b.target.result;e?(h.push(e.value.item),e.continue()):("function"==typeof c&&c(h),a._Depot.closeIndexedDb(d))},g.onerror=function(){"function"==typeof c&&c(h),a._Depot.closeIndexedDb(d)}}):b.storageType===a.storageType.WEBSQL?console.log("WEBSQL"):b.storageType===a.storageType.LOCALSTORAGE&&console.log("LOCALSTORAGE")},setItem:function(b,c,d,e){b.storageType===a.storageType.INDEXEDDB?a._Depot.openIndexedDb(b.name,a.indexedDbVersion,function(f){var g,h,i=f.transaction([b.name],"readwrite");g=i.objectStore(b.name),i.oncomplete=function(){"function"==typeof e&&e(!0),a._Depot.closeIndexedDb(f)},i.onerror=function(){"function"==typeof e&&e(!1),a._Depot.closeIndexedDb(f)},h=g.put({item:c,data:d})}):b.storageType===a.storageType.WEBSQL?console.log("WEBSQL"):b.storageType===a.storageType.LOCALSTORAGE&&console.log("LOCALSTORAGE")},hasItem:function(b,c,d){b.storageType===a.storageType.INDEXEDDB?a._Depot.getItem(b,c,function(a){d("undefined"!=typeof a?!0:!1)}):b.storageType===a.storageType.WEBSQL?console.log("WEBSQL"):b.storageType===a.storageType.LOCALSTORAGE&&console.log("LOCALSTORAGE")},removeItem:function(b,c,d){b.storageType===a.storageType.INDEXEDDB?a._Depot.openIndexedDb(b.name,a.indexedDbVersion,function(e){var f,g,h;g=e.transaction([b.name],"readwrite"),f=g.objectStore(b.name),h=f.delete(c),h.onsuccess=function(){"function"==typeof d&&d(!0),a._Depot.closeIndexedDb(e)},h.onerror=function(){"function"==typeof d&&d(!1),a._Depot.closeIndexedDb(e)}}):b.storageType===a.storageType.WEBSQL?console.log("WEBSQL"):b.storageType===a.storageType.LOCALSTORAGE&&console.log("LOCALSTORAGE")},clear:function(b){b.storageType===a.storageType.INDEXEDDB?a._Depot.openIndexedDb(b.name,a.indexedDbVersion,function(c){window.indexedDB.deleteDatabase(b.name),a._Depot.closeIndexedDb(c)}):b.storageType===a.storageType.WEBSQL?console.log("WEBSQL"):b.storageType===a.storageType.LOCALSTORAGE&&console.log("LOCALSTORAGE")},openIndexedDb:function(b,c,d){var e=window.indexedDB.open(b,c);e.onerror=function(){d(null)},e.onupgradeneeded=function(){if(!e.result.objectStoreNames.contains(b)){var c=e.result.createObjectStore(b,{keyPath:a.DB_INDEXING_KEY});c.createIndex(a.DB_INDEXING_KEY,a.DB_INDEXING_KEY,{unique:!0})}},e.onsuccess=function(){"function"==typeof d&&d(e.result)}},closeIndexedDb:function(a){a&&a.close&&a.close()}},a.requestDepot=function(b,c,d){a._hasDepot(b,function(e){e?c(a._getDepot(b)):a._createDepot(b,c,d)})},a.hasDepot=function(b,c){"string"==typeof b&&"function"==typeof c?a._hasDepot(b,c):c(!1)},a.deleteDepot=function(b,c){if(a.deviceStorageType===a.storageType.INDEXEDDB){var d=window.indexedDB.deleteDatabase(b);d.onsuccess=function(){"function"==typeof c&&c(!0)},d.onerror=function(){"function"==typeof c&&c(!1)}}else console.log(a.deviceStorageType===a.storageType.WEBSQL?"WEBSQL":a.deviceStorageType===a.storageType.LOCALSTORAGE?"LOCALSTORAGE":"UNSUPPORTED")},a._hasDepot=function(b,c){if(a.deviceStorageType===a.storageType.INDEXEDDB){var d=window.indexedDB.open(b);d.onupgradeneeded=function(a){a.target.transaction.abort()},d.onsuccess=function(){"function"==typeof c&&(a._Depot.closeIndexedDb(d),c(!0))},d.onerror=function(){"function"==typeof c&&(a._Depot.closeIndexedDb(d),c(!1))}}else console.log(a.deviceStorageType===a.storageType.WEBSQL?"WEBSQL":a.deviceStorageType===a.storageType.LOCALSTORAGE?"LOCALSTORAGE":"UNSUPPORTED")},a._getDepot=function(b){return new a.Depot(b,a.deviceStorageType)},a._createDepot=function(b,c,d){a.deviceStorageType===a.storageType.INDEXEDDB?a._createIndexedDbInstance(b,c,d):console.log(a.deviceStorageType===a.storageType.WEBSQL?"WEBSQL":a.deviceStorageType===a.storageType.LOCALSTORAGE?"LOCALSTORAGE":"UNSUPPORTED")},a._createIndexedDbInstance=function(b,c,d){var e=window.indexedDB.open(b,a.indexedDbVersion);e.onerror=function(b){"function"==typeof d&&d(b),"function"==typeof a.onError&&a.onError(b)},e.onupgradeneeded=function(){if(!e.result.objectStoreNames.contains(b)){var c=e.result.createObjectStore(b,{keyPath:a.DB_INDEXING_KEY});c.createIndex(a.DB_INDEXING_KEY,a.DB_INDEXING_KEY,{unique:!0})}},e.onsuccess=function(){"function"==typeof c&&(c(new a.Depot(b,a.storageType.INDEXEDDB)),a._Depot.closeIndexedDb(e.result))}},a._getStorageSupportedByBrowser=function(){var b;return void 0!==window.indexedDB?b=a.storageType.INDEXEDDB:window.openDatabase?b=a.storageType.WEBSQL:"localStorage"in window&&(b=a.storageType.LOCALSTORAGE),b},a._init=function(){a.deviceStorageType=a._getStorageSupportedByBrowser()},a._init()}}();
